{% extends "base.html" %}
{% block title %}{{ cafe.name }} • Menu{% endblock %}

{% block content %}
<div x-data="menuApp()">
  <!-- Search + Badges -->
  <div class="flex flex-col gap-3 sm:flex-row sm:items-center mb-4">
    <div class="relative flex-1">
      <input x-model="query" type="search" placeholder="Cari menu…"
        class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 pr-10 outline-none focus:ring-2 focus:ring-brand" />
      <svg class="absolute right-3 top-3.5 w-5 h-5 text-slate-400" viewBox="0 0 24 24" fill="none">
        <path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"
              stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
      </svg>
    </div>
    <div class="flex gap-2">
      <button @click="sort='popular'" :class="btn(sort==='popular')">Terpopuler</button>
      <button @click="sort='price_asc'" :class="btn(sort==='price_asc')">Termurah</button>
      <button @click="sort='price_desc'" :class="btn(sort==='price_desc')">Termahal</button>
    </div>
  </div>

  <!-- Category tabs -->
  <div class="flex overflow-auto gap-2 pb-2 mb-3">
    <button @click="tab=null" :class="tabBtn(tab===null)">Semua</button>
    {% for c in categories %}
      <button @click="tab={{ c.id }}" :class="tabBtn(tab==={{ c.id }})">{{ c.name }}</button>
    {% endfor %}
  </div>

  <!-- Menu grid -->
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
    {% for it in items %}
    <div
      x-show="showItem({{ it.id }}, {{ it.category_id|default('null') }}, '{{ it.name|e }}', {{ it.price_cents }})"
      class="group bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
      {% if it.image_url %}
        <img src="{{ it.image_url }}" alt="{{ it.name }}" class="h-36 w-full object-cover">
      {% else %}
        <div class="h-36 w-full bg-slate-100 grid place-content-center text-slate-400">no image</div>
      {% endif %}
      <div class="p-3">
        <h3 class="font-semibold text-sm line-clamp-2">{{ it.name }}</h3>
        {% if it.description %}
          <p class="text-xs text-slate-500 line-clamp-2 mt-1">{{ it.description }}</p>
        {% endif %}
        <div class="flex items-center justify-between pt-2">
          <span class="font-bold text-brand" x-text="fmt({{ it.price_cents }})"></span>
          <button @click="add({ id: {{ it.id }}, name: '{{ it.name|e }}', price: {{ it.price_cents }} })"
                  class="px-3 py-1 rounded-lg border border-slate-200 hover:border-brand hover:text-brand text-xs">
            + Keranjang
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Cart -->
  <div class="fixed bottom-4 inset-x-0 px-4">
    <div class="mx-auto max-w-5xl">
      <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-3 flex items-center justify-between"
           x-show="cart.length > 0" x-transition>
        <div class="text-sm">
          <span class="font-semibold" x-text="cart.length + ' item'"></span>
          <span class="text-slate-500 ml-2" x-text="'Total ' + fmt(total())"></span>
        </div>
        <div class="flex gap-2">
          <button @click="share()"
                  class="px-3 py-2 rounded-lg text-xs border border-slate-200">Bagikan</button>
          <button @click="checkout()"
                  class="px-4 py-2 rounded-xl bg-brand text-white text-xs font-semibold">Checkout</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function menuApp(){
  return {
    query: '', tab: null, sort: 'popular', cart: JSON.parse(localStorage.getItem('qr_cart')||'[]'),
    btn(active){ return (active? 'bg-slate-900 text-white':'bg-white') + ' px-3 py-2 rounded-xl text-xs border border-slate-200'; },
    tabBtn(active){ return (active? 'bg-brand text-white':'bg-white') + ' px-4 py-2 rounded-full text-xs border'; },
    fmt(c){ return new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', maximumFractionDigits:0 }).format(c); },
    showItem(id, catId, name, price){
      if(this.tab!==null && this.tab!==catId) return false;
      if(this.query && !name.toLowerCase().includes(this.query.toLowerCase())) return false;
      return true;
    },
    add(item){
      const found=this.cart.find(x=>x.id===item.id);
      if(found) found.qty+=1; else this.cart.push({...item, qty:1});
      localStorage.setItem('qr_cart', JSON.stringify(this.cart));
    },
    total(){ return this.cart.reduce((s,x)=>s+x.price*x.qty,0); },
    async checkout(){
      alert('Checkout dummy (stub). Nanti integrasi payment link di frontend premium).');
    },
    share(){
      const url = window.location.href;
      if(navigator.share) navigator.share({title: document.title, url});
      else navigator.clipboard.writeText(url).then(()=>alert('Link disalin: '+url));
    }
  }
}
</script>
{% endblock %}
